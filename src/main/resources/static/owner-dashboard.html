<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Park Ease - Owner Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .slot-tile.editable:hover {
        transform: scale(1.05);
        cursor: pointer;
        border-color: #6366f1;
      }
      .slot-tile.locked {
        cursor: not-allowed;
        opacity: 0.7;
      }
    </style>
    <script src="js/export-utils.js"></script>
  </head>
  <body class="bg-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-amber-900 text-white shadow-lg sticky top-0 z-50">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div class="bg-amber-700 p-1.5 rounded-lg">üè¢</div>
          <h1 class="font-bold text-lg tracking-wide">Owner Console</h1>
        </div>
        <div class="flex items-center gap-4">
          <span
            id="owner-name"
            class="text-sm text-amber-200 font-medium hidden sm:block"
            >Owner</span
          >
          <a
            href="profile.html"
            class="text-sm bg-amber-800 hover:bg-amber-700 px-3 py-1.5 rounded-lg transition"
            >Back to User View</a
          >
        </div>
      </div>
    </header>

    <div class="max-w-full mx-auto px-3 sm:px-3 lg:px-3 py-8">
      <!-- TOP ROW: Area Selection & Creation -->
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-3 mb-8">
        <!-- Area List -->
        <div class="lg:col-span-1">
          <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full"
          >
            <div
              class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center"
            >
              <h2 class="font-bold text-gray-700 text-sm">My Properties</h2>
              <button
                onclick="toggleCreateArea()"
                class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded font-bold hover:bg-amber-200"
              >
                + New Area
              </button>
            </div>
            <div
              id="area-list"
              class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto"
            >
              <div class="p-6 text-center text-gray-400 text-xs">
                Loading areas...
              </div>
            </div>
          </div>
        </div>

        <!-- Context Area: Selected Area Details (Hidden initially) -->
        <div id="selected-area-panel" class="lg:col-span-4 hidden">
          <div
            class="bg-gray-800 rounded-xl shadow-sm border border-gray-200 p-6"
          >
            <div class="flex justify-between items-start mb-6">
              <div>
                <h2 id="sa-name" class="text-2xl font-bold text-white">
                  Area Name
                </h2>
                <p id="sa-address" class="text-sm text-white">
                  Address line...
                </p>
              </div>
              <div class="text-right">
                <span
                  id="sa-id"
                  class="text-xs bg-white font-black text-gray-900 px-2 py-1 rounded"
                  >ID: --</span
                >
                <button
                  onclick="disableArea()"
                  class="block mt-2 text-xs md:text-md text-red-600 hover:underline font-black"
                  title="Sets only AVAILABLE slots to Maintenance"
                >
                  Safe Disable (Maintenance)
                </button>
              </div>
            </div>

            <!-- TABS -->
            <div class="border-b border-gray-200 mb-6">
              <nav class="-mb-px flex space-x-8 overflow-auto">
                <button
                  onclick="switchTab('slots')"
                  id="tab-slots"
                  class="border-amber-500 text-amber-600 hover:text-amber-200 whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm shrink-0"
                >
                  Slots & Config
                </button>

                <button
                  onclick="switchTab('stats')"
                  id="tab-stats"
                  class="border-transparent text-white hover:text-amber-200 hover:border-gray-300 whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm shrink-0"
                >
                  Analytics
                </button>
                <button
                  onclick="switchTab('logs')"
                  id="tab-logs"
                  class="border-transparent text-white hover:text-amber-200 hover:border-gray-300 whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm shrink-0"
                >
                  Logs
                </button>

                <button
                  onclick="switchTab('guards')"
                  id="tab-guards"
                  class="border-transparent text-white hover:text-amber-200 hover:border-gray-300 whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm shrink-0"
                >
                  Guard Staffing
                </button>
                <!-- NEW TAB -->
              </nav>
            </div>

            <!-- TAB: SLOTS -->
            <div id="view-slots">
              <div
                class="bg-white rounded pt-0 px-4 pb-4 h-[400px] overflow-y-auto border border-gray-100 relative"
              >
                <div
                  class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 pb-2 z-10"
                >
                  <h3 class="text-xs font-bold text-gray-500 uppercase">
                    Live Slot Grid
                  </h3>
                  <!-- NEW: Add Single Slot Button -->
                  <div>
                    <button
                      onclick="toggleCreateSlot()"
                      class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded shadow font-bold"
                    >
                      + Add Slot
                    </button>
                    <button
                      onclick="makeAllAvailable()"
                      class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs px-3 py-1.5 rounded shadow font-bold"
                    >
                      ‚úì Make All Available
                    </button>
                  </div>
                </div>

                <!-- Grid Container -->
                <div
                  id="live-slots-grid"
                  class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3"
                >
                  <!-- Slots injected here -->
                </div>
              </div>
            </div>

            <!-- TAB: GUARDS -->
            <div id="view-guards" class="hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Recruit Form -->
                <div
                  class="bg-amber-50 p-4 rounded-lg border border-amber-100 h-fit"
                >
                  <h3 class="text-xs font-bold text-amber-800 uppercase mb-3">
                    Recruit New Guard
                  </h3>
                  <div class="space-y-3">
                    <input
                      id="g-name"
                      class="w-full text-xs p-2.5 rounded border border-amber-200"
                      placeholder="Guard Name"
                    />
                    <input
                      id="g-email"
                      class="w-full text-xs p-2.5 rounded border border-amber-200"
                      placeholder="Email"
                    />
                    <input
                      id="g-phone"
                      class="w-full text-xs p-2.5 rounded border border-amber-200"
                      placeholder="Phone"
                    />
                    <input
                      id="g-pass"
                      type="password"
                      class="w-full text-xs p-2.5 rounded border border-amber-200"
                      placeholder="Password"
                    />
                    <button
                      onclick="recruitGuard()"
                      class="w-full bg-amber-600 text-white text-xs py-2.5 rounded font-bold hover:bg-amber-700 shadow-sm"
                    >
                      Recruit
                    </button>
                  </div>
                </div>
                <!-- Guard List -->
                <div class="bg-white p-4 rounded-lg border border-gray-100">
                  <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">
                    Active Guards
                  </h3>
                  <div id="guard-list" class="space-y-3">
                    <p class="text-xs text-gray-400">
                      Select area to see guards.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- TAB: ANALYTICS -->
            <!-- <div id="view-stats" class="hidden">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                  <p class="text-xs text-green-600 uppercase font-bold">
                    Total Earnings
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    ‚Çπ<span id="st-earnings">0</span>
                  </h3>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                  <p class="text-xs text-red-600 uppercase font-bold">
                    Pending Dues
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    ‚Çπ<span id="st-pending">0</span>
                  </h3>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                  <p class="text-xs text-blue-600 uppercase font-bold">
                    Total Bookings
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    <span id="st-total">0</span>
                  </h3>
                </div>
                <div
                  class="bg-purple-50 p-4 rounded-xl border border-purple-100"
                >
                  <p class="text-xs text-purple-600 uppercase font-bold">
                    Active Now
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    <span id="st-active">0</span>
                  </h3>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white border rounded-xl p-4">
                  <h4
                    class="text-sm font-bold text-gray-700 mb-3 border-b pb-2"
                  >
                    Booking Status
                  </h4>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Completed</span
                    ><span id="st-completed" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Cancelled (No Show)</span
                    ><span id="st-cancelled" class="font-bold text-red-500"
                      >0</span
                    >
                  </div>
                </div>

                <div class="bg-white border rounded-xl p-4">
                  <h4
                    class="text-sm font-bold text-gray-700 mb-3 border-b pb-2"
                  >
                    Engagement & Time
                  </h4>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Unique Users</span
                    ><span id="st-users" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Unique Vehicles</span
                    ><span id="st-vehicles" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Reservation Hours</span
                    ><span id="st-res-hrs" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Parking Hours</span
                    ><span id="st-park-hrs" class="font-bold">0</span>
                  </div>
                </div>
               
                <div class="mt-8 border-t border-gray-200 pt-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4">
                    Top Performing Slots
                  </h3>

                
                  <h4 class="text-xs font-bold text-indigo-600 uppercase mb-2">
                    Last 24 Hours
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
         
                    <div class="bg-white border rounded-lg">
                      <div
                        class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-600"
                      >
                        Top Revenue
                      </div>
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody id="table-rev-24" class="text-xs"></tbody>
                      </table>
                    </div>
                   
                    <div class="bg-white border rounded-lg">
                      <div
                        class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-600"
                      >
                        Top Occupancy Time
                      </div>
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody id="table-time-24" class="text-xs"></tbody>
                      </table>
                    </div>
                  </div>

                 
                  <h4 class="text-xs font-bold text-purple-600 uppercase mb-2">
                    Last 30 Days
                  </h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  
                    <div class="bg-white border rounded-lg">
                      <div
                        class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-600"
                      >
                        Top Revenue
                      </div>
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody id="table-rev-30" class="text-xs"></tbody>
                      </table>
                    </div>
                    
                    <div class="bg-white border rounded-lg">
                      <div
                        class="bg-gray-50 px-4 py-2 border-b text-xs font-bold text-gray-600"
                      >
                        Top Occupancy Time
                      </div>
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody id="table-time-30" class="text-xs"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>


            </div> -->
            <div id="view-stats" class="hidden">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div
                  class="bg-green-100 p-4 rounded-xl border border-green-100"
                >
                  <p class="text-xs text-green-600 uppercase font-bold">
                    Total Earnings
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    ‚Çπ<span id="st-earnings">0</span>
                  </h3>
                </div>
                <div class="bg-red-100 p-4 rounded-xl border border-red-100">
                  <p class="text-xs text-red-600 uppercase font-bold">
                    Pending Dues
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    ‚Çπ<span id="st-pending">0</span>
                  </h3>
                </div>
                <div class="bg-blue-100 p-4 rounded-xl border border-blue-100">
                  <p class="text-xs text-blue-600 uppercase font-bold">
                    Total Bookings
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    <span id="st-total">0</span>
                  </h3>
                </div>
                <div
                  class="bg-purple-100 p-4 rounded-xl border border-purple-100"
                >
                  <p class="text-xs text-purple-600 uppercase font-bold">
                    Active Now
                  </p>
                  <h3 class="text-xl font-bold text-gray-800">
                    <span id="st-active">0</span>
                  </h3>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border rounded-xl p-4">
                  <h4
                    class="text-sm font-bold text-gray-700 mb-3 border-b pb-2"
                  >
                    Booking Status
                  </h4>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Completed</span
                    ><span id="st-completed" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Cancelled (No Show)</span
                    ><span id="st-cancelled" class="font-bold text-red-500"
                      >0</span
                    >
                  </div>
                </div>

                <div class="bg-white border rounded-xl p-4">
                  <h4
                    class="text-sm font-bold text-gray-700 mb-3 border-b pb-2"
                  >
                    Engagement & Time
                  </h4>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Unique Users</span
                    ><span id="st-users" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Unique Vehicles</span
                    ><span id="st-vehicles" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Reservation Hours</span
                    ><span id="st-res-hrs" class="font-bold">0</span>
                  </div>
                  <div class="flex justify-between text-xs mb-2">
                    <span>Parking Hours</span
                    ><span id="st-park-hrs" class="font-bold">0</span>
                  </div>
                </div>
              </div>

              <div class="mt-8 border-t border-gray-200 pt-6">
                <h3 class="text-lg font-bold text-white mb-4">
                  Top Performing Slots
                </h3>

                <h4
                  class="text-xs font-bold text-indigo-400 uppercase mb-3 flex items-center gap-2"
                >
                  <span class="w-2 h-2 rounded-full bg-indigo-400"></span> Last
                  24 Hours
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  <div
                    class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                  >
                    <div
                      class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center"
                    >
                      <span class="text-xs font-bold text-gray-700"
                        >Top Revenue</span
                      >
                      <span
                        class="text-[10px] text-gray-400 bg-white border px-2 py-0.5 rounded"
                        >‚Çπ Generated</span
                      >
                    </div>
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody
                          id="table-rev-24"
                          class="text-xs divide-y divide-gray-50 bg-white"
                        ></tbody>
                      </table>
                    </div>
                  </div>
                  <div
                    class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                  >
                    <div
                      class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center"
                    >
                      <span class="text-xs font-bold text-gray-700"
                        >Top Occupancy</span
                      >
                      <span
                        class="text-[10px] text-gray-400 bg-white border px-2 py-0.5 rounded"
                        >Hours</span
                      >
                    </div>
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody
                          id="table-time-24"
                          class="text-xs divide-y divide-gray-50 bg-white"
                        ></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <h4
                  class="text-xs font-bold text-purple-400 uppercase mb-3 flex items-center gap-2"
                >
                  <span class="w-2 h-2 rounded-full bg-purple-400"></span> Last
                  30 Days
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div
                    class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                  >
                    <div
                      class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center"
                    >
                      <span class="text-xs font-bold text-gray-700"
                        >Top Revenue</span
                      >
                      <span
                        class="text-[10px] text-gray-400 bg-white border px-2 py-0.5 rounded"
                        >‚Çπ Generated</span
                      >
                    </div>
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody
                          id="table-rev-30"
                          class="text-xs divide-y divide-gray-50 bg-white"
                        ></tbody>
                      </table>
                    </div>
                  </div>
                  <div
                    class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                  >
                    <div
                      class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center"
                    >
                      <span class="text-xs font-bold text-gray-700"
                        >Top Occupancy</span
                      >
                      <span
                        class="text-[10px] text-gray-400 bg-white border px-2 py-0.5 rounded"
                        >Hours</span
                      >
                    </div>
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-100">
                        <tbody
                          id="table-time-30"
                          class="text-xs divide-y divide-gray-50 bg-white"
                        ></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Charts Section -->
              <div class="mt-8 border-t border-gray-200 pt-6">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-lg font-bold text-white">
                    Performance Trends
                  </h3>
                  <div class="flex gap-2">
                    <!-- Toggle View Buttons -->
                    <div
                      class="bg-gray-200 p-1 rounded-lg flex text-sm font-bold"
                    >
                      <button
                        onclick="switchChartView('24h')"
                        id="btn-chart-24h"
                        class="px-3 py-1 rounded-md bg-white shadow text-indigo-600 transition"
                      >
                        24 Hours
                      </button>
                      <button
                        onclick="switchChartView('30d')"
                        id="btn-chart-30d"
                        class="px-3 py-1 rounded-md text-gray-500 hover:text-gray-700 transition"
                      >
                        30 Days
                      </button>
                    </div>
                    <!-- Export Button -->
                    <button
                      onclick="exportChartData()"
                      class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-1"
                    >
                      <svg
                        class="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      CSV
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Revenue Chart -->
                  <div
                    class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm"
                  >
                    <canvas id="revenueChart"></canvas>
                  </div>

                  <!-- Bookings Count Chart -->
                  <div
                    class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm"
                  >
                    <canvas id="countChart"></canvas>
                  </div>

                  <!-- Duration Chart (Full Width) -->
                  <div
                    class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm md:col-span-1"
                  >
                    <canvas id="durationChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- TAB: LOGS (NEW) -->
            <div id="view-logs" class="hidden">
              <div id="view-logs" class="">
                <!-- NEW: Export Button -->
                <!-- <div class="flex justify-end mb-3">
                  <button
                    onclick="exportLogs()"
                    class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded flex items-center gap-2 shadow-sm"
                  >
                    <svg
                      class="w-3 h-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                      />
                    </svg>
                    Download CSV
                  </button>
                </div> -->
                <!-- Controls -->
                <div>
                  <h2 class="font-black text-white">
                    Export Detailed Report in CSV
                  </h2>
                  <div
                    class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"
                  >
                    <div class="flex gap-2 w-full md:w-auto">
                      <input
                        type="date"
                        id="log-start"
                        class="border rounded p-2 text-xs w-full"
                      />
                      <input
                        type="date"
                        id="log-end"
                        class="border rounded p-2 text-xs w-full"
                      />
                    </div>
                    <button
                      onclick="exportLogs()"
                      class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded shadow flex items-center gap-2 w-full md:w-auto justify-center"
                    >
                      <svg
                        class="w-3 h-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Export CSV
                    </button>
                  </div>
                </div>

                <!-- Existing Table Container -->
                <div
                  class="bg-white rounded-lg border border-gray-200 overflow-hidden"
                >
                  <!-- ... existing table code ... -->
                </div>
              </div>
              <div
                class="bg-white rounded-lg border border-gray-200 overflow-auto max-h-[650px]"
              >
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          ID
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          Date/Time Start
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          Date/Time End
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          User
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          Vehicle
                        </th>
                        <th
                          class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase"
                        >
                          Status
                        </th>
                        <th
                          class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase"
                        >
                          Amount
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="logs-table-body"
                      class="bg-white divide-y divide-gray-200"
                    >
                      <tr>
                        <td
                          colspan="6"
                          class="px-4 py-8 text-center text-xs text-gray-400"
                        >
                          Loading logs...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: CREATE AREA -->
      <div
        id="modal-create"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm"
      >
        <div
          class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-900">
              Create New Parking Area
            </h2>
            <button
              onclick="toggleCreateArea()"
              class="text-gray-950 hover:text-gray-600"
            >
              ‚úï
            </button>
          </div>
          <form onsubmit="createArea(event)" class="space-y-6">
            <input
              id="ca-name"
              class="w-full border p-2 rounded text-sm focus:ring-amber-500"
              placeholder="Area Name"
              required
            />
            <input
              id="ca-addr"
              class="w-full border p-2 rounded text-sm focus:ring-amber-500"
              placeholder="Address"
              required
            />
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label for="" class="text-sm text-gray-700">Lattitude</label>
                <input
                  id="ca-lat"
                  class="border p-2 rounded text-sm"
                  placeholder="Latitude"
                  value="22.7"
                />
              </div>
              <div>
                <label for="" class="text-sm text-gray-700">Longitude</label>
                <input
                  id="ca-lon"
                  class="border p-2 rounded text-sm"
                  placeholder="Longitude"
                  value="75.8"
                />
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mt-2"
                >Capacity</label
              >
              <div class="grid grid-cols-3 gap-2">
                <input
                  id="cap-s"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Small"
                  required
                />
                <input
                  id="cap-m"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Med"
                  required
                />
                <input
                  id="cap-l"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Large"
                  required
                />
              </div>
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-500 mt-2"
                >Hourly Rates (‚Çπ)</label
              >
              <div class="grid grid-cols-3 gap-2">
                <input
                  id="rate-s"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Small"
                  required
                />
                <input
                  id="rate-m"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Med"
                  required
                />
                <input
                  id="rate-l"
                  type="number"
                  class="border p-2 rounded text-sm"
                  placeholder="Large"
                  required
                />
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-amber-600 text-white font-bold py-3 rounded mt-4 hover:bg-amber-700 shadow-md"
            >
              Create & Generate Slots
            </button>
          </form>
        </div>
      </div>

      <!-- MODAL: CREATE SINGLE SLOT (NEW) -->
      <div
        id="modal-create-slot"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm"
      >
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-900">Add New Slot</h2>
            <button
              onclick="toggleCreateSlot()"
              class="text-gray-400 hover:text-gray-600"
            >
              ‚úï
            </button>
          </div>

          <form onsubmit="createNewSlot(event)" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Slot Name/Number</label
              >
              <input
                type="text"
                id="new-slot-name"
                class="w-full border p-2 rounded text-sm focus:ring-indigo-500"
                placeholder="e.g. B2-505"
                required
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Floor</label
              >
              <input
                type="number"
                id="new-slot-floor"
                class="w-full border p-2 rounded text-sm"
                placeholder="0"
                required
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Vehicle Type</label
              >
              <select
                id="new-slot-type"
                class="w-full border p-2 rounded text-sm bg-white"
              >
                <option value="SMALL">Small (Bike)</option>
                <option value="MEDIUM" selected>Medium (Car)</option>
                <option value="LARGE">Large (SUV)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Hourly Rate (‚Çπ)</label
              >
              <input
                type="number"
                id="new-slot-rate"
                class="w-full border p-2 rounded text-sm"
                placeholder="50"
                required
              />
            </div>

            <div
              class="bg-gray-100 p-2 rounded text-[10px] text-gray-500 italic text-center"
            >
              Note: New slots are created in MAINTENANCE mode by default.
            </div>

            <button
              type="submit"
              class="w-full bg-indigo-600 text-white font-bold py-2 rounded hover:bg-indigo-700 shadow-md"
            >
              Create Slot
            </button>
          </form>
        </div>
      </div>

      <!-- MODAL: EDIT SLOT -->
      <div
        id="modal-edit-slot"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm"
      >
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-900">
              Edit Slot
              <span id="edit-slot-display" class="text-indigo-600"></span>
            </h2>
            <button
              onclick="toggleEditSlot()"
              class="text-gray-400 hover:text-gray-600"
            >
              ‚úï
            </button>
          </div>
          <input type="hidden" id="edit-slot-id" />

          <div class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Status</label
              >
              <select
                id="edit-slot-status"
                class="w-full border p-2 rounded text-sm bg-white"
              >
                <option value="AVAILABLE">Available (Green)</option>
                <option value="MAINTENANCE">Maintenance (Grey)</option>
                <!-- Removed OCCUPIED/RESERVED options to prevent manual override -->
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Hourly Rate (‚Çπ)</label
              >
              <input
                type="number"
                id="edit-slot-rate"
                class="w-full border p-2 rounded text-sm"
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Floor</label
              >
              <input
                type="number"
                id="edit-slot-floor"
                class="w-full border p-2 rounded text-sm"
              />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Slot Number (Name)</label
              >
              <input
                type="text"
                id="edit-slot-number"
                class="w-full border p-2 rounded text-sm"
              />
            </div>

            <button
              onclick="submitSlotUpdate()"
              class="w-full bg-indigo-600 text-white font-bold py-2 rounded hover:bg-indigo-700"
            >
              Update Slot
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8080/api";
      const token = localStorage.getItem("parkease_token");
      let selectedAreaId = null;
      let currentSlots = []; // Store locally for bulk filtering

      if (!token) window.location.href = "auth.html";

      async function init() {
        try {
          const user = await fetchAPI("/user/profile");
          if (user.role !== "AREA_OWNER" && user.role !== "ADMIN") {
            alert("Access Denied: Owners Only");
            window.location.href = "dashboard.html";
            return;
          }
          document.getElementById("owner-name").innerText = user.name;
          loadAreas();
        } catch (e) {
          console.error(e);
          alert("Session Error");
          window.location.href = "auth.html";
        }
      }

      async function fetchAPI(endpoint, method = "GET", body = null) {
        const headers = {
          "Content-Type": "application/json",
          "X-Auth-Token": token,
        };
        const opts = { method, headers };
        if (body) opts.body = JSON.stringify(body);

        const res = await fetch(`${API_BASE}${endpoint}`, opts);
        const text = await res.text();

        if (!res.ok) throw new Error(text);
        try {
          return JSON.parse(text);
        } catch {
          return text;
        }
      }

      // --- AREA MANAGEMENT ---
      async function loadAreas() {
        const list = document.getElementById("area-list");
        try {
          const areas = await fetchAPI("/area-owner/my-areas");

          if (areas.length === 0) {
            list.innerHTML =
              '<div class="p-6 text-center text-gray-400 text-xs">No areas found. Create one!</div>';
            return;
          }

          let html = "";
          areas.forEach((a) => {
            html += `
                    <div onclick="selectArea(${a.areaId}, '${a.name}', '${a.address}')" 
                         class="p-4 hover:bg-amber-50 cursor-pointer transition border-l-4 border-transparent hover:border-amber-500 group">
                        <div class="font-bold text-gray-800 text-sm group-hover:text-amber-800">${a.name}</div>
                        <div class="text-xs text-gray-500 ">${a.address}</div>
                    </div>`;
          });
          list.innerHTML = html;
        } catch (err) {
          list.innerHTML = `<div class="p-4 text-red-500 text-xs">Error: ${err.message}</div>`;
        }
      }

      function toggleCreateSlot() {
        document.getElementById("modal-create-slot").classList.toggle("hidden");
      }

      async function createNewSlot(e) {
        e.preventDefault();
        if (!selectedAreaId) return;

        const payload = {
          slotNumber: document.getElementById("new-slot-name").value,
          floor: parseInt(document.getElementById("new-slot-floor").value),
          supportedVehicleType: document.getElementById("new-slot-type").value,
          baseHourlyRate: parseFloat(
            document.getElementById("new-slot-rate").value
          ),
        };

        try {
          const res = await fetchAPI(
            `/area-owner/area/${selectedAreaId}/slots/create`,
            "POST",
            payload
          );
          alert(res.message);
          toggleCreateSlot();
          loadSlots(selectedAreaId);
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      // --- NEW: LOGS ---
      // async function loadLogs(id) {
      //   const tbody = document.getElementById("logs-table-body");
      //   tbody.innerHTML =
      //     '<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-gray-400">Loading...</td></tr>';
      //   try {
      //     const logs = await fetchAPI(`/area-owner/area/${id}/logs`);
      //     // ‚úÖ STORE DATA GLOBALLY
      //     currentLogs = logs || [];
      //     tbody.innerHTML = "";

      //     if (!logs.length) {
      //       tbody.innerHTML =
      //         '<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-gray-400">No logs found.</td></tr>';
      //       return;
      //     }

      //     logs.forEach((log) => {
      //       let statusColor = "text-gray-500";
      //       if (log.status === "COMPLETED") statusColor = "text-green-600";
      //       if (log.status === "CANCELLED_NO_SHOW")
      //         statusColor = "text-red-500";
      //       if (log.status === "RESERVED" || log.status === "ACTIVE_PARKING")
      //         statusColor = "text-amber-600";

      //       const dateStr = new Date(log.time).toLocaleString([], {
      //         month: "short",
      //         day: "numeric",
      //         hour: "2-digit",
      //         minute: "2-digit",
      //       });

      //       tbody.innerHTML += `
      //               <tr class="hover:bg-gray-50">
      //                   <td class="px-4 py-2 text-xs font-mono text-gray-500">#${
      //                     log.bookingId
      //                   }</td>
      //                   <td class="px-4 py-2 text-xs text-gray-600">${dateStr}</td>
      //                   <td class="px-4 py-2 text-xs text-gray-800 font-bold">${
      //                     log.userName
      //                   }<br><span class="font-normal text-gray-400">${
      //         log.userPhone
      //       }</span></td>
      //                   <td class="px-4 py-2 text-xs text-gray-600 font-mono">${
      //                     log.vehicleNumber
      //                   }</td>
      //                   <td class="px-4 py-2 text-xs font-bold ${statusColor}">${log.status.replace(
      //         "_",
      //         " "
      //       )}<br><span class="text-gray-400 font-normal">Slot: ${
      //         log.slotNumber
      //       }</span></td>
      //                   <td class="px-4 py-2 text-xs text-right font-mono font-bold text-gray-800">‚Çπ${log.amount.toFixed(
      //                     2
      //                   )}</td>
      //               </tr>`;
      //     });
      //   } catch (err) {
      //     tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-red-500">Error: ${err.message}</td></tr>`;
      //   }
      // }
      // function exportLogs() {
      //   if (!currentLogs || currentLogs.length === 0) {
      //     alert("No logs available to export.");
      //     return;
      //   }

      //   // 1. Map Data to Flat Structure
      //   const flatData = currentLogs.map((log) => {
      //     return {
      //       ID: log.bookingId,
      //       "Date/Time": new Date(log.time).toLocaleString(),
      //       UserName: log.userName,
      //       MobileNumber: log.userPhone,
      //       Vehicle: log.vehicleNumber,
      //       Status: log.status,
      //       SlotNumber: log.slotNumber,
      //       Amount: log.amount.toFixed(2),
      //     };
      //   });

      //   // 2. Define Headers and Keys
      //   const headers = [
      //     "ID",
      //     "Date/Time",
      //     "UserName",
      //     "MobileNumber",
      //     "Vehicle",
      //     "Status",
      //     "SlotNumber",
      //     "Amount",
      //   ];
      //   const keys = [
      //     "ID",
      //     "Date/Time",
      //     "UserName",
      //     "MobileNumber",
      //     "Vehicle",
      //     "Status",
      //     "SlotNumber",
      //     "Amount",
      //   ];

      //   // 3. Download
      //   const filename = `parking_logs_area_${selectedAreaId}.csv`;
      //   ExportUtils.downloadCSV(flatData, headers, keys, filename);
      // }

      async function loadLogs(id) {
        const tbody = document.getElementById("logs-table-body");
        try {
          const logs = await fetchAPI(`/area-owner/area/${id}/logs`);

          // Store globally for export
          currentLogs = logs || [];

          tbody.innerHTML = "";

          if (!logs || logs.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-gray-400">No logs found.</td></tr>';
            return;
          }

          logs.forEach((log) => {
            let statusColor = "text-gray-500";
            if (log.status === "COMPLETED") statusColor = "text-green-600";
            if (
              log.status === "CANCELLED_NO_SHOW" ||
              log.status === "DEFAULTED"
            )
              statusColor = "text-red-500";
            if (log.status === "RESERVED" || log.status === "ACTIVE_PARKING")
              statusColor = "text-amber-600";

            const dateStr = new Date(log.time).toLocaleString();
            const dateStr2 = new Date(log.time2).toLocaleString();

            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-2 text-xs font-mono text-gray-500">#${
                      log.bookingId
                    }</td>
                    <td class="px-4 py-2 text-xs text-gray-600 whitespace-nowrap">${dateStr}</td>
                    <td class="px-4 py-2 text-xs text-gray-600 whitespace-nowrap">${dateStr2}</td>
                    <td class="px-4 py-2 text-xs text-gray-800">
                        <div class="font-bold">${log.userName}</div>
                        <div class="font-normal text-gray-400 text-[10px]">${
                          log.userPhone
                        }</div>
                    </td>
                    <td class="px-4 py-2 text-xs text-gray-600 font-mono">${
                      log.vehicleNumber
                    }</td>
                    <td class="px-4 py-2 text-xs font-bold ${statusColor}">
                        ${log.status.replace(/_/g, " ")}
                        <div class="text-gray-400 font-normal text-[10px]">Slot: ${
                          log.slotNumber
                        }</div>
                    </td>
                    <td class="px-4 py-2 text-xs text-right font-mono font-bold text-gray-800">‚Çπ${log.amount.toFixed(
                      2
                    )}</td>
                </tr>`;
          });
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-xs text-red-500">Error loading logs: ${err.message}</td></tr>`;
        }
      }

      function exportLogs() {
        if (!currentLogs || currentLogs.length === 0) {
          alert("No logs available to export.");
          return;
        }

        const start = document.getElementById("log-start").value;
        const end = document.getElementById("log-end").value;

        // 1. Filter using Utility (time field matches DTO)
        const filtered = ExportUtils.filterByDate(
          currentLogs,
          "time start",
          // "time end",
          start,
          end
        );

        // 2. Map to Flat CSV Structure
        const flatData = filtered.map((log) => ({
          ID: log.bookingId,
          "Date/Time Start": new Date(log.time).toLocaleString(),
          "Date/Time End": new Date(log.time2).toLocaleString(),
          UserName: log.userName,
          MobileNumber: log.userPhone,
          Vehicle: log.vehicleNumber,
          Status: log.status,
          SlotNumber: log.slotNumber,
          Amount: log.amount.toFixed(2),
        }));

        // 3. Define Headers
        const headers = [
          "ID",
          "Date/Time Start",
          "Date/Time End",
          "UserName",
          "MobileNumber",
          "Vehicle",
          "Status",
          "SlotNumber",
          "Amount",
        ];
        const keys = [
          "ID",
          "Date/Time Start",
          "Date/Time End",
          "UserName",
          "MobileNumber",
          "Vehicle",
          "Status",
          "SlotNumber",
          "Amount",
        ];

        // 4. Download
        ExportUtils.downloadCSV(
          flatData,
          headers,
          keys,
          `Area_${selectedAreaId}_Logs.csv`
        );
      }
      async function createArea(e) {
        e.preventDefault();
        const payload = {
          name: document.getElementById("ca-name").value,
          address: document.getElementById("ca-addr").value,
          latitude: document.getElementById("ca-lat").value,
          longitude: document.getElementById("ca-lon").value,
          capacitySmall: parseInt(document.getElementById("cap-s").value),
          capacityMedium: parseInt(document.getElementById("cap-m").value),
          capacityLarge: parseInt(document.getElementById("cap-l").value),
          baseRateSmall: parseFloat(document.getElementById("rate-s").value),
          baseRateMedium: parseFloat(document.getElementById("rate-m").value),
          baseRateLarge: parseFloat(document.getElementById("rate-l").value),
        };

        try {
          const res = await fetchAPI(
            "/area-owner/create-area",
            "POST",
            payload
          );
          alert(res.message);
          toggleCreateArea();
          loadAreas();
        } catch (err) {
          alert("Creation Failed: " + err.message);
        }
      }

      function toggleCreateArea() {
        document.getElementById("modal-create").classList.toggle("hidden");
      }

      function toggleEditSlot() {
        document.getElementById("modal-edit-slot").classList.toggle("hidden");
      }

      // --- CONTEXT LOGIC ---
      function selectArea(id, name, addr) {
        selectedAreaId = id;
        document
          .getElementById("selected-area-panel")
          .classList.remove("hidden");
        document.getElementById("sa-name").innerText = name;
        document.getElementById("sa-address").innerText = addr;
        document.getElementById("sa-id").innerText = `ID: ${id}`;
        loadSlots(id);
        loadGuards(id);
        loadStats(id);
        loadLogs(id);
        loadChartData(id);
      }

      // function switchTab(tab) {
      //   const slotsView = document.getElementById("view-slots");
      //   const guardsView = document.getElementById("view-guards");
      //   const tSlots = document.getElementById("tab-slots");
      //   const tGuards = document.getElementById("tab-guards");

      //   if (tab === "slots") {
      //     slotsView.classList.remove("hidden");
      //     guardsView.classList.add("hidden");
      //     tSlots.classList.add("border-amber-500", "text-amber-600");
      //     tGuards.classList.remove("border-amber-500", "text-amber-600");
      //   } else {
      //     slotsView.classList.add("hidden");
      //     guardsView.classList.remove("hidden");
      //     tGuards.classList.add("border-amber-500", "text-amber-600");
      //     tSlots.classList.remove("border-amber-500", "text-amber-600");
      //   }
      // }

      function switchTab(tab) {
        const views = ["slots", "guards", "stats", "logs"];
        views.forEach((v) => {
          const el = document.getElementById(`view-${v}`);
          const btn = document.getElementById(`tab-${v}`);

          if (v === tab) {
            el.classList.remove("hidden");
            btn.classList.add("border-amber-500", "text-amber-600");
            btn.classList.remove("border-transparent", "text-white");
          } else {
            el.classList.add("hidden");
            btn.classList.remove("border-amber-500", "text-amber-600");
            btn.classList.add("border-transparent", "text-white");
          }
        });
      }

      // --- GLOBAL CHART VARIABLES ---
      let chartDataStore = { hourly: [], daily: [] }; // Store data for CSV export
      let currentChartMode = "24h"; // '24h' or '30d'
      let charts = {}; // Store Chart.js instances to destroy/update

      // Add this call to your existing selectArea function
      // loadChartData(id);

      async function loadChartData(id) {
        try {
          const data = await fetchAPI(
            `/area-owner/area/${id}/analytics/charts`
          );
          chartDataStore.hourly = data.hourlyData;
          chartDataStore.daily = data.dailyData;

          // Render default view (24h)
          renderCharts(chartDataStore.hourly);
        } catch (err) {
          console.error("Chart Error", err);
        }
      }

      function switchChartView(mode) {
        currentChartMode = mode;

        // Update Buttons
        const btn24 = document.getElementById("btn-chart-24h");
        const btn30 = document.getElementById("btn-chart-30d");

        if (mode === "24h") {
          btn24.classList.add("bg-white", "shadow", "text-indigo-600");
          btn24.classList.remove("text-gray-500");
          btn30.classList.remove("bg-white", "shadow", "text-indigo-600");
          btn30.classList.add("text-gray-500");
          renderCharts(chartDataStore.hourly);
        } else {
          btn30.classList.add("bg-white", "shadow", "text-indigo-600");
          btn30.classList.remove("text-gray-500");
          btn24.classList.remove("bg-white", "shadow", "text-indigo-600");
          btn24.classList.add("text-gray-500");
          renderCharts(chartDataStore.daily);
        }
      }

      function renderCharts(dataPoints) {
        const labels = dataPoints.map((d) => d.label);
        const revenue = dataPoints.map((d) => d.revenue);
        const counts = dataPoints.map((d) => d.bookingCount);
        const durations = dataPoints.map((d) => d.avgDurationHrs);

        // Helper to create/update chart
        const createChart = (canvasId, label, data, color, type = "line") => {
          const ctx = document.getElementById(canvasId).getContext("2d");

          // Destroy existing if present
          if (charts[canvasId]) charts[canvasId].destroy();

          charts[canvasId] = new Chart(ctx, {
            type: type,
            data: {
              labels: labels,
              datasets: [
                {
                  label: label,
                  data: data,
                  borderColor: color,
                  backgroundColor: color + "20", // Transparent fill
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: label },
              },
              scales: { y: { beginAtZero: true } },
            },
          });
        };

        createChart("revenueChart", "Revenue (‚Çπ)", revenue, "#059669"); // Green
        createChart("countChart", "Total Bookings", counts, "#4F46E5", "bar"); // Indigo Bar
        createChart(
          "durationChart",
          "Avg Duration (Hours)",
          durations,
          "#D97706"
        ); // Amber
      }

      function exportChartData() {
        const data =
          currentChartMode === "24h"
            ? chartDataStore.hourly
            : chartDataStore.daily;

        if (!data || data.length === 0) return alert("No chart data to export");

        const flatData = data.map((d) => ({
          "Time/Date": d.label,
          "Revenue (INR)": d.revenue.toFixed(2),
          "Bookings Count": d.bookingCount,
          "Avg Duration (Hrs)": d.avgDurationHrs.toFixed(2),
        }));

        const headers = [
          "Time/Date",
          "Revenue (INR)",
          "Bookings Count",
          "Avg Duration (Hrs)",
        ];
        const keys = [
          "Time/Date",
          "Revenue (INR)",
          "Bookings Count",
          "Avg Duration (Hrs)",
        ];

        ExportUtils.downloadCSV(
          flatData,
          headers,
          keys,
          `Analytics_${currentChartMode}_Area_${selectedAreaId}.csv`
        );
      }

      async function loadStats(id) {
        try {
          const stats = await fetchAPI(`/area-owner/area/${id}/stats`);

          document.getElementById("st-earnings").innerText =
            stats.totalEarnings.toFixed(2);
          document.getElementById("st-pending").innerText =
            stats.totalPending.toFixed(2);
          document.getElementById("st-total").innerText = stats.totalBookings;
          document.getElementById("st-active").innerText = stats.activeBookings;

          document.getElementById("st-completed").innerText =
            stats.completedBookings;
          document.getElementById("st-cancelled").innerText =
            stats.cancelledBookings;

          document.getElementById("st-users").innerText = stats.uniqueUsers;
          document.getElementById("st-vehicles").innerText =
            stats.uniqueVehicles;
          document.getElementById("st-res-hrs").innerText =
            stats.totalReservationHours.toFixed(2);
          document.getElementById("st-park-hrs").innerText =
            stats.totalParkingHours.toFixed(2);

          // 2. Load Slot Tables (NEW)
          const slotStats = await fetchAPI(
            `/area-owner/area/${id}/analytics/slots`
          );

          renderSlotTable("table-rev-24", slotStats.topRevenue24h, "‚Çπ");
          renderSlotTable("table-time-24", slotStats.topTime24h, "hrs");
          renderSlotTable("table-rev-30", slotStats.topRevenue30d, "‚Çπ");
          renderSlotTable("table-time-30", slotStats.topTime30d, "hrs");
        } catch (err) {
          console.error("Failed to load stats", err);
        }
      }

      // Helper to render rows
      // function renderSlotTable(elementId, data, unit) {
      //   const tbody = document.getElementById(elementId);
      //   tbody.innerHTML = "";

      //   if (!data || data.length === 0) {
      //     tbody.innerHTML =
      //       '<tr><td class="p-3 text-center text-gray-400">No data</td></tr>';
      //     return;
      //   }

      //   data.forEach((d, index) => {
      //     tbody.innerHTML += `
      //           <tr>
      //               <td class="px-4 py-2 font-bold text-gray-700 w-10">#${
      //                 index + 1
      //               }</td>
      //               <td class="px-4 py-2 text-gray-800">${d.slotNumber}</td>
      //               <td class="px-4 py-2 text-right font-mono font-bold text-indigo-600">
      //                   ${
      //                     unit === "‚Çπ"
      //                       ? "‚Çπ" + d.value.toFixed(2)
      //                       : d.value.toFixed(1) + " hrs"
      //                   }
      //               </td>
      //               <td class="px-4 py-2 text-right text-gray-400 text-[10px]">${
      //                 d.bookingCount
      //               } bookings</td>
      //           </tr>`;
      //   });
      // }

      // Helper to render rows with better layout
      function renderSlotTable(elementId, data, unit) {
        const tbody = document.getElementById(elementId);
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="p-4 text-center text-gray-400 text-xs italic">No data available for this period.</td></tr>';
          return;
        }

        data.forEach((d, index) => {
          // Medal colors for top 3
          let rankClass = "text-gray-400 font-medium";
          let rankIcon = `#${index + 1}`;

          if (index === 0) {
            rankClass = "text-amber-500 font-bold";
            rankIcon = "ü•á";
          } else if (index === 1) {
            rankClass = "text-slate-400 font-bold";
            rankIcon = "ü•à";
          } else if (index === 2) {
            rankClass = "text-orange-400 font-bold";
            rankIcon = "ü•â";
          }

          tbody.innerHTML += `
        <tr class="hover:bg-gray-50 transition-colors group">
            <td class="pl-4 pr-2 py-3 w-8 text-center whitespace-nowrap ${rankClass}">
                ${rankIcon}
            </td>
            
            <td class="px-2 py-3 whitespace-nowrap">
                <div class="text-sm font-bold text-gray-700 group-hover:text-indigo-600 transition-colors">
                    ${d.slotNumber}
                </div>
            </td>

            <td class="px-2 py-3 text-right whitespace-nowrap">
                 <div class="font-mono font-bold text-gray-800 text-sm">
                    ${unit === "‚Çπ" ? "‚Çπ" : ""}${d.value.toFixed(1)}${
            unit === "hrs"
              ? "<span class='text-xs text-gray-900 font-sans ml-0.5'>hrs</span>"
              : ""
          }
                 </div>
            </td>

            <td class="pl-2 pr-4 py-3 text-right whitespace-nowrap">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-[12px] font-bold bg-gray-100 text-gray-900 border border-gray-200">
                    ${d.bookingCount} bookings
                </span>
            </td>
        </tr>`;
        });
      }

      // --- SLOTS (NEW VISUAL EDITOR) ---
      async function loadSlots(id) {
        let currentLogs = []; // Store logs for export
        const grid = document.getElementById("live-slots-grid");
        grid.innerHTML =
          '<div class="col-span-4 text-xs text-center">Loading slots...</div>';

        try {
          currentSlots = await fetchAPI(`/area-owner/area/${id}/slots`);
          grid.innerHTML = "";

          currentSlots.forEach((s) => {
            let color = "bg-gray-200 text-gray-500 editable";
            let isLocked = false;

            if (s.status === "AVAILABLE")
              color =
                "bg-green-100 text-green-700 border border-green-200 editable";
            if (s.status === "MAINTENANCE")
              color =
                "bg-gray-700 text-gray-300 border border-gray-600 editable";

            // Locked states
            if (s.status === "OCCUPIED") {
              color = "bg-red-100 text-red-700 border border-red-200 locked";
              isLocked = true;
            }
            if (s.status === "RESERVED") {
              color =
                "bg-yellow-100 text-yellow-700 border border-yellow-200 locked";
              isLocked = true;
            }

            const div = document.createElement("div");
            div.className = `slot-tile ${color} rounded p-2 text-center transition-all shadow-sm`;
            div.innerHTML = `
                        <div class="text-[10px] font-bold">${s.slotNumber}</div>
                        <div class="text-[8px] opacity-70 mt-1">${s.status.substring(
                          0,
                          4
                        )}</div>
                        <div class="text-[8px] mt-1">‚Çπ${s.baseHourlyRate}</div>
                    `;

            // Only attach click listener if not locked
            if (!isLocked) {
              div.onclick = () => openSlotEditor(s);
            }

            grid.appendChild(div);
          });
        } catch (err) {
          grid.innerHTML = `<div class="col-span-4 text-xs text-red-500">${err.message}</div>`;
        }
      }

      function openSlotEditor(slot) {
        document.getElementById("edit-slot-id").value = slot.slotId;
        document.getElementById("edit-slot-display").innerText =
          slot.slotNumber;
        document.getElementById("edit-slot-number").value = slot.slotNumber;
        document.getElementById("edit-slot-floor").value = slot.floor;
        document.getElementById("edit-slot-rate").value = slot.baseHourlyRate;
        document.getElementById("edit-slot-status").value = slot.status;

        toggleEditSlot();
      }

      async function submitSlotUpdate() {
        if (!selectedAreaId) return;
        const slotId = document.getElementById("edit-slot-id").value;

        const payload = [
          {
            slotId: parseInt(slotId),
            slotNumber: document.getElementById("edit-slot-number").value,
            floor: parseInt(document.getElementById("edit-slot-floor").value),
            hourlyRate: parseFloat(
              document.getElementById("edit-slot-rate").value
            ),
            status: document.getElementById("edit-slot-status").value,
          },
        ];

        try {
          const res = await fetchAPI(
            `/area-owner/area/${selectedAreaId}/slots/update`,
            "PUT",
            payload
          );
          alert(res.message);
          toggleEditSlot();
          loadSlots(selectedAreaId);
        } catch (err) {
          alert("Update Failed: " + err.message);
        }
      }

      async function disableArea() {
        if (!selectedAreaId) return;

        // Safe Filter: Only target AVAILABLE slots
        const targetSlots = currentSlots.filter(
          (s) => s.status === "AVAILABLE"
        );

        if (targetSlots.length === 0) {
          alert(
            "No AVAILABLE slots to disable.\n(Occupied/Reserved slots are protected)."
          );
          return;
        }

        if (
          !confirm(
            `Switch ${targetSlots.length} AVAILABLE slots to Maintenance Mode?\n(Active sessions will be unaffected)`
          )
        )
          return;

        // Construct payload for bulk update instead of wiping everything
        const payload = targetSlots.map((s) => ({
          slotId: s.slotId,
          status: "MAINTENANCE",
        }));

        try {
          const res = await fetchAPI(
            `/area-owner/area/${selectedAreaId}/slots/update`,
            "PUT",
            payload
          );
          alert(`${res.message} (${targetSlots.length} slots disabled)`);
          loadSlots(selectedAreaId);
        } catch (err) {
          alert(err.message);
        }
      }

      // --- NEW: MAKE ALL AVAILABLE ---
      async function makeAllAvailable() {
        if (!selectedAreaId) return;
        if (
          !confirm(
            "This will change all MAINTENANCE slots to AVAILABLE. Occupied/Reserved slots will remain unchanged. Continue?"
          )
        )
          return;

        // Filter locally to find only maintenance slots
        const maintenanceSlots = currentSlots.filter(
          (s) => s.status === "MAINTENANCE"
        );

        if (maintenanceSlots.length === 0) {
          alert("No slots are currently in Maintenance.");
          return;
        }

        // Construct bulk update payload
        const payload = maintenanceSlots.map((s) => ({
          slotId: s.slotId,
          status: "AVAILABLE",
        }));

        try {
          const res = await fetchAPI(
            `/area-owner/area/${selectedAreaId}/slots/update`,
            "PUT",
            payload
          );
          alert(`${res.message} (${payload.length} slots updated)`);
          loadSlots(selectedAreaId);
        } catch (err) {
          alert("Bulk Update Failed: " + err.message);
        }
      }

      // --- GUARDS (FIXED) ---
      async function loadGuards(id) {
        const list = document.getElementById("guard-list");
        try {
          const guards = await fetchAPI(`/area-owner/area/${id}/guards`);
          list.innerHTML = "";

          if (!Array.isArray(guards) || guards.length === 0) {
            list.innerHTML =
              '<p class="text-xs text-gray-400 italic">No guards hired.</p>';
            return;
          }

          guards.forEach((g) => {
            let uid, name;
            if (g.user && g.user.userId) {
              uid = g.user.userId;
              name = g.user.name;
            } else if (g.userId) {
              uid = g.userId;
              name = g.name;
            } else {
              console.error("Unknown Guard Structure:", g);
              return;
            }

            const div = document.createElement("div");
            div.className =
              "flex justify-between items-center p-3 bg-white border rounded shadow-sm";
            div.innerHTML = `
                        <div>
                            <span class="font-bold text-gray-700 text-xs">${name}</span>
                            <span class="text-gray-400 block text-[10px]">ID: ${uid}</span>
                        </div>
                        <button class="text-red-500 hover:text-white hover:bg-red-500 font-bold border border-red-200 px-3 py-1 rounded text-xs transition">Fire</button>
                    `;
            div.querySelector("button").onclick = () => fireGuard(uid);
            list.appendChild(div);
          });
        } catch (err) {
          list.innerHTML = `<p class="text-xs text-red-500">${err.message}</p>`;
        }
      }

      async function recruitGuard() {
        if (!selectedAreaId) return;
        const payload = {
          areaId: selectedAreaId,
          name: document.getElementById("g-name").value,
          email: document.getElementById("g-email").value,
          phone: document.getElementById("g-phone").value,
          password: document.getElementById("g-pass").value,
        };
        try {
          const res = await fetchAPI(
            "/area-owner/recruit-guard",
            "POST",
            payload
          );
          alert(res.message);
          document.getElementById("g-name").value = "";
          document.getElementById("g-email").value = "";
          document.getElementById("g-phone").value = "";
          document.getElementById("g-pass").value = "";
          loadGuards(selectedAreaId);
        } catch (err) {
          alert(err.message);
        }
      }

      async function fireGuard(userId) {
        if (!confirm("Fire this guard? They will become a Driver.")) return;
        try {
          const res = await fetchAPI(
            `/area-owner/fire-guard/${userId}`,
            "POST"
          );
          alert(res.message);
          loadGuards(selectedAreaId);
        } catch (err) {
          alert(err.message);
        }
      }

      init();
    </script>
  </body>
</html>
